name: Build Android APK

on:
  push:
    branches: [main, mobile-app]
  pull_request:
    branches: [main, mobile-app]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
        
      - name: Install NDK
        run: |
          sdkmanager --install "ndk;25.2.9519653"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Create React Native project
        run: |
          npx --yes @react-native-community/cli@latest init BrainAndHandApp --directory rn-app --skip-git-init --skip-install --pm npm

      - name: Install RN dependencies
        working-directory: rn-app
        run: npm install

      - name: Install nodejs-mobile-react-native
        working-directory: rn-app
        run: npm install nodejs-mobile-react-native --save

      - name: Copy Brain & Hand UI
        run: |
          # Inject API key if provided
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            sed -i "s|%%ANTHROPIC_API_KEY%%|${{ secrets.ANTHROPIC_API_KEY }}|g" mobile/App.tsx
          fi
          cp mobile/App.tsx rn-app/App.tsx

      - name: Setup nodejs-assets
        run: |
          mkdir -p rn-app/nodejs-assets/nodejs-project
          cp nodejs-assets/nodejs-project/main.js rn-app/nodejs-assets/nodejs-project/
          cp nodejs-assets/nodejs-project/package.json rn-app/nodejs-assets/nodejs-project/

      - name: Install Node.js project dependencies
        working-directory: rn-app/nodejs-assets/nodejs-project
        run: |
          # Install openclaw (this may take a while due to native deps)
          npm install --production || echo "Some deps may have failed"

      - name: Configure Metro to ignore nodejs-project
        working-directory: rn-app
        run: |
          cat > metro.config.js << 'EOF'
          const {getDefaultConfig, mergeConfig} = require('@react-native/metro-config');
          const config = {
            resolver: {
              blockList: [/nodejs-assets\/.*/],
            },
          };
          module.exports = mergeConfig(getDefaultConfig(__dirname), config);
          EOF

      - name: Bundle JavaScript for Release
        working-directory: rn-app
        run: |
          mkdir -p android/app/src/main/assets
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res

      - name: Build Android Release APK
        working-directory: rn-app/android
        run: ./gradlew assembleRelease --no-daemon
        continue-on-error: true

      - name: Build Debug APK (fallback)
        if: failure()
        working-directory: rn-app/android
        run: ./gradlew assembleDebug --no-daemon

      - name: List build outputs
        run: find rn-app/android -name "*.apk" -type f 2>/dev/null || echo "No APKs found"

      - name: Find and copy APKs
        run: |
          echo "Looking for APKs..."
          find rn-app/android -name "*.apk" -type f
          mkdir -p artifacts
          # Copy any APK we find
          find rn-app/android -name "*.apk" -type f -exec cp {} artifacts/ \;
          ls -la artifacts/
          # Check if we have any
          if [ -z "$(ls -A artifacts/)" ]; then
            echo "No APKs found!"
            exit 1
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: brain-and-hand-apk
          path: artifacts/*.apk
